name: ğŸ·ï¸ Auto-Label PRs & Issues

on:
  pull_request:
    types: [opened, edited, synchronize]
  issues:
    types: [opened, edited]

jobs:
  auto-label-pr:
    name: ğŸ·ï¸ Auto-Label Pull Request
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ·ï¸ Label based on changed files
        uses: actions/labeler@v5
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ·ï¸ Label based on size
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const additions = pr.additions;
            const deletions = pr.deletions;
            const total = additions + deletions;

            let sizeLabel = '';
            if (total < 50) sizeLabel = 'effort: 1h';
            else if (total < 200) sizeLabel = 'effort: 3h';
            else if (total < 500) sizeLabel = 'effort: 1d';
            else if (total < 1000) sizeLabel = 'effort: 3d';
            else sizeLabel = 'effort: 1w';

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: [sizeLabel]
            });

      - name: ğŸ·ï¸ Label based on branch name
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const branch = pr.head.ref.toLowerCase();
            const labels = [];

            // Detect type from branch name
            if (branch.startsWith('feature/')) labels.push('type: feature');
            if (branch.startsWith('fix/') || branch.startsWith('bugfix/')) labels.push('type: bug');
            if (branch.startsWith('hotfix/')) {
              labels.push('type: bug', 'priority: critical');
            }
            if (branch.startsWith('chore/')) labels.push('type: chore');
            if (branch.startsWith('docs/')) labels.push('type: documentation');
            if (branch.startsWith('refactor/')) labels.push('type: refactor');

            // Detect project from branch name
            if (branch.includes('empathy-ledger')) labels.push('project: empathy-ledger');
            if (branch.includes('justicehub')) labels.push('project: justicehub');
            if (branch.includes('harvest')) labels.push('project: harvest');
            if (branch.includes('placemat')) labels.push('project: placemat');
            if (branch.includes('goods')) labels.push('project: goods');

            // Detect LCAA phase
            if (branch.includes('listen')) labels.push('lcaa: listen');
            if (branch.includes('curiosity') || branch.includes('prototype')) labels.push('lcaa: curiosity');
            if (branch.includes('action') || branch.includes('implement')) labels.push('lcaa: action');
            if (branch.includes('art') || branch.includes('design')) labels.push('lcaa: art');

            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels
              });
            }

  check-pr-template:
    name: âœ… Verify PR Template
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: âœ… Check for ACT Quality Checklist
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || '';

            const hasLCAA = body.includes('LCAA Method') || body.includes('Listen') && body.includes('Curiosity');
            const hasChecklist = body.includes('- [ ]') || body.includes('- [x]');

            if (!hasLCAA || !hasChecklist) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: `## âš ï¸ Missing ACT Quality Checklist

            This PR doesn't include the ACT Quality Checklist. Please ensure your PR description includes:

            - ğŸŒ¾ **LCAA Method** alignment
            - âœ… **Checklist items** for reviewers

            You can use the PR template by leaving the description empty when creating the PR.

            ---
            ğŸ¤– *Automated check from ACT PM system*`
              });

              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: ['needs: discussion']
              });
            }

  auto-assign:
    name: ğŸ‘¥ Auto-Assign Reviewers
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: ğŸ‘¥ Assign based on CODEOWNERS
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;

            // TODO: Read CODEOWNERS file and assign appropriate reviewers
            // For now, just add a label to indicate review is needed
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: ['status: ready for review']
            });

  welcome-contributor:
    name: ğŸ‘‹ Welcome New Contributors
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'opened'

    steps:
      - name: ğŸ‘‹ Welcome message
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;

            // Check if this is the user's first PR
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              creator: pr.user.login
            });

            if (prs.length === 1) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: `## ğŸŒ¾ Welcome to ACT!

            Thank you for your first contribution to the ACT ecosystem, @${pr.user.login}!

            ### What happens next?
            - A maintainer will review your PR soon
            - Please ensure all CI checks pass
            - Feel free to ask questions in the comments

            ### About ACT
            We're building the farm for a post-extractive economy through our LCAA method:
            **Listen** â†’ **Curiosity** â†’ **Action** â†’ **Art**

            Your contribution is part of something bigger. Thank you for helping us cultivate regenerative systems! ğŸŒ±

            ---
            *Check out our other projects: [Empathy Ledger](https://github.com/Acurioustractor/empathy-ledger-v2), [JusticeHub](https://github.com/Acurioustractor/justicehub-platform), [The Harvest](https://github.com/Acurioustractor/theharvest)*`
              });

              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: ['good first issue']
              });
            }
