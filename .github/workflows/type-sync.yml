name: ðŸ”„ Type Sync Across ACT Ecosystem

on:
  push:
    branches: [main]
    paths:
      - 'src/types/**'
      - 'database.types.ts'
  workflow_dispatch:

jobs:
  detect-changes:
    name: ðŸ” Detect Type Changes
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.changes.outputs.has_changes }}
      changed_files: ${{ steps.changes.outputs.changed_files }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: ðŸ” Detect changed type files
        id: changes
        run: |
          CHANGED=$(git diff --name-only HEAD~1 HEAD -- 'src/types/**' 'database.types.ts' || echo "")
          if [ -n "$CHANGED" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "changed_files<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGED" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

  sync-to-empathy-ledger:
    name: ðŸ”„ Sync to Empathy Ledger
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'

    steps:
      - name: ðŸ“¥ Checkout ACT Main
        uses: actions/checkout@v4
        with:
          path: act-main

      - name: ðŸ“¥ Checkout Empathy Ledger
        uses: actions/checkout@v4
        with:
          repository: Acurioustractor/empathy-ledger-v2
          token: ${{ secrets.GITHUB_TOKEN }}
          path: empathy-ledger

      - name: ðŸ”„ Copy shared types
        run: |
          # Copy database types if changed
          if [ -f "act-main/database.types.ts" ]; then
            cp act-main/database.types.ts empathy-ledger/database.types.ts
            echo "âœ… Copied database.types.ts"
          fi

          # Copy shared type definitions
          if [ -d "act-main/src/types/shared" ]; then
            mkdir -p empathy-ledger/src/types/shared
            cp -r act-main/src/types/shared/* empathy-ledger/src/types/shared/
            echo "âœ… Copied shared types"
          fi

      - name: ðŸ“ Create PR if changes exist
        working-directory: empathy-ledger
        run: |
          git config user.name "ACT Type Sync Bot"
          git config user.email "noreply@acurioustractor.com"

          if [ -n "$(git status --porcelain)" ]; then
            BRANCH_NAME="type-sync-$(date +%Y%m%d-%H%M%S)"
            git checkout -b $BRANCH_NAME
            git add .
            git commit -m "chore: sync types from ACT Main

          Auto-synced shared types from act-regenerative-studio.

          Changed files:
          ${{ needs.detect-changes.outputs.changed_files }}

          ðŸ¤– Generated by Type Sync workflow"

            git push origin $BRANCH_NAME

            # Create PR using GitHub CLI
            gh pr create \
              --title "ðŸ”„ Type Sync from ACT Main" \
              --body "## ðŸ”„ Automated Type Synchronization

          This PR updates shared types from \`act-regenerative-studio\`.

          ### Changed Files
          \`\`\`
          ${{ needs.detect-changes.outputs.changed_files }}
          \`\`\`

          ### Review Checklist
          - [ ] Verify types are compatible with current codebase
          - [ ] Run \`npm run type-check\` to ensure no breaking changes
          - [ ] Update any consuming code if necessary

          ---
          ðŸ¤– Auto-generated by ACT Type Sync workflow" \
              --label "type: chore" \
              --label "priority: medium"
          else
            echo "No changes to sync"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  sync-to-other-repos:
    name: ðŸ”„ Sync to Other Repos
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    strategy:
      matrix:
        repo:
          - name: justicehub-platform
            has_types: false
          - name: theharvest
            has_types: false
          - name: act-farm
            has_types: false

    steps:
      - name: ðŸ“Š Report sync status
        run: |
          echo "ðŸ“‹ Would sync to: ${{ matrix.repo.name }}"
          echo "   Has shared types: ${{ matrix.repo.has_types }}"
          # TODO: Implement sync for repos that use shared types

  summary:
    name: ðŸ“Š Sync Summary
    runs-on: ubuntu-latest
    needs: [detect-changes, sync-to-empathy-ledger]
    if: always()

    steps:
      - name: ðŸ“Š Post summary
        run: |
          echo "## ðŸ”„ Type Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Changes Detected" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ needs.detect-changes.outputs.changed_files }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Sync Status" >> $GITHUB_STEP_SUMMARY
          echo "- Empathy Ledger: ${{ needs.sync-to-empathy-ledger.result }}" >> $GITHUB_STEP_SUMMARY
